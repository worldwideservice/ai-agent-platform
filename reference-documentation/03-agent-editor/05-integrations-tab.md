# Вкладка "Интеграции" (Integrations Tab)

![Скриншот вкладки Интеграции](../screenshots/agent_edit_integrations_tab_1763892067879.png)

## Общее описание
Вкладка "Интеграции" управляет подключением агента к внешним сервисам и платформам. Здесь настраиваются интеграции с CRM, календарями, мессенджерами и другими инструментами.

## Структура интерфейса

### Заголовок секции
- **Текст**: "Интеграции"
- **Описание**: "Подключите внешние сервисы для расширения возможностей агента"

### Список доступных интеграций

На скриншоте видны две интеграции:

#### 1. Google Calendar
- **Название**: "Google Calendar"
- **Иконка**: Логотип Google Calendar
- **Описание**: "Управление событиями и встречами в календаре"
- **Статус**: Не подключено (предположительно)
- **Кнопка**: "Настроить" или "Подключить"

#### 2. Kommo (amoCRM)
- **Название**: "Kommo"
- **Иконка**: Логотип Kommo
- **Описание**: "Интеграция с CRM системой для работы со сделками и контактами"
- **Статус**: Не подключено (предположительно)
- **Кнопка**: "Настроить" или "Подключить"

### Структура карточки интеграции

Каждая интеграция отображается как карточка:

1. **Иконка сервиса**
   - Расположение: Левая часть карточки
   - Размер: Средний (48x48px или 64x64px)

2. **Название интеграции**
   - Расположение: Рядом с иконкой
   - Шрифт: Жирный

3. **Описание**
   - Краткое описание возможностей интеграции
   - Шрифт: Обычный, серый цвет

4. **Статус подключения**
   - Индикатор: "Подключено" (зеленый) / "Не подключено" (серый)
   - Может включать дату последней синхронизации

5. **Кнопка действия**
   - **Не подключено**: "Подключить" (синяя кнопка)
   - **Подключено**: "Настроить" (серая кнопка) + "Отключить"

## Типы интеграций

### 1. CRM системы
- **Kommo (amoCRM)**
- **Bitrix24**
- **Salesforce**
- **HubSpot**

**Функционал**:
- Доступ к сделкам и контактам
- Создание и обновление сделок
- Управление задачами
- Работа с полями и тегами

### 2. Календари
- **Google Calendar**
- **Microsoft Outlook Calendar**
- **Apple Calendar**

**Функционал**:
- Создание событий
- Проверка занятости
- Отправка приглашений
- Управление встречами

### 3. Мессенджеры
- **WhatsApp Business API**
- **Telegram Bot API**
- **Facebook Messenger**
- **Instagram Direct**

**Функционал**:
- Отправка сообщений
- Получение сообщений
- Обработка входящих запросов
- Отправка медиа-файлов

### 4. Email
- **Gmail API**
- **Microsoft Outlook**
- **SendGrid**
- **Mailgun**

**Функционал**:
- Отправка писем
- Чтение входящих
- Работа с шаблонами
- Отслеживание открытий

### 5. Платежные системы
- **Stripe**
- **PayPal**
- **Yookassa**

**Функционал**:
- Создание счетов
- Прием платежей
- Проверка статуса оплаты

### 6. Другие сервисы
- **Zapier** (для подключения тысяч сервисов)
- **Make (Integromat)**
- **Custom Webhooks**

## Модальное окно настройки интеграции

### Для Google Calendar

#### Шаг 1: Авторизация
- **Кнопка**: "Войти через Google"
- **Процесс**: OAuth 2.0 авторизация
- **Разрешения**: Доступ к календарям

#### Шаг 2: Выбор календаря
- **Элемент**: Выпадающий список календарей
- **Опции**: Все доступные календари пользователя

#### Шаг 3: Настройки
- **Автоматическое создание событий**: Toggle
- **Длительность встречи по умолчанию**: Число (минуты)
- **Часовой пояс**: Выбор из списка
- **Уведомления**: Настройка напоминаний

### Для Kommo (CRM)

#### Шаг 1: Подключение
- **Поле "Поддомен"**: Текстовое поле (например, "mycompany.kommo.com")
- **Поле "API ключ"**: Текстовое поле
- **Кнопка**: "Подключить"

#### Шаг 2: Настройки синхронизации
- **Синхронизация сделок**: Toggle
- **Синхронизация контактов**: Toggle
- **Синхронизация задач**: Toggle
- **Частота синхронизации**: Выбор (реального времени, каждые 5 мин, каждый час)

#### Шаг 3: Маппинг полей
- **Таблица соответствия полей**:
  - Поле агента → Поле CRM
  - Возможность добавления кастомных полей

#### Шаг 4: Webhook настройки
- **URL webhook**: Автоматически сгенерированный
- **События**: Выбор событий для отправки (создание сделки, изменение статуса и т.д.)

### Для мессенджеров (WhatsApp)

#### Шаг 1: Выбор провайдера
- **Опции**: WhatsApp Business API, Twilio, MessageBird и др.

#### Шаг 2: API ключи
- **API Key**: Текстовое поле
- **Phone Number ID**: Текстовое поле
- **Webhook Token**: Текстовое поле

#### Шаг 3: Настройки
- **Автоответы**: Toggle
- **Рабочие часы**: Настройка расписания
- **Шаблоны сообщений**: Список утвержденных шаблонов

## Логика работы

### Сценарий подключения интеграции:
1. Пользователь нажимает "Подключить" на карточке интеграции
2. Открывается модальное окно настройки
3. Пользователь проходит авторизацию (OAuth или API ключи)
4. Пользователь настраивает параметры интеграции
5. Система проверяет подключение (тестовый запрос)
6. При успехе интеграция активируется
7. Статус меняется на "Подключено"

### Сценарий использования интеграции:
1. Агент получает задачу (например, создать встречу)
2. Агент обращается к соответствующей интеграции
3. Интеграция выполняет действие через API
4. Результат возвращается агенту
5. Агент сообщает пользователю о результате

## API взаимодействие

### Получение списка интеграций:
- **Endpoint**: `GET /api/integrations`
- **Response**:
  ```json
  {
    "integrations": [
      {
        "id": "google_calendar",
        "name": "Google Calendar",
        "description": "...",
        "icon": "url_to_icon",
        "category": "calendar",
        "status": "available|connected|configured",
        "config": {}
      }
    ]
  }
  ```

### Подключение интеграции:
- **Endpoint**: `POST /api/agents/{agentId}/integrations/{integrationId}/connect`
- **Payload**: Зависит от типа интеграции

### Настройка интеграции:
- **Endpoint**: `PUT /api/agents/{agentId}/integrations/{integrationId}/config`

### Отключение интеграции:
- **Endpoint**: `DELETE /api/agents/{agentId}/integrations/{integrationId}`

### Тестирование интеграции:
- **Endpoint**: `POST /api/agents/{agentId}/integrations/{integrationId}/test`

## Зависимости

- **Вкладка "Сделки и контакты"**: Зависит от подключенной CRM
- **Триггеры и Цепочки**: Используют интеграции для выполнения действий
- **Внешние API**: Требуют активных аккаунтов в соответствующих сервисах

## Валидация

- API ключи должны быть валидными
- Подключение должно быть успешно протестировано
- Обязательные поля должны быть заполнены
- Разрешения должны быть предоставлены

## Состояния интерфейса

1. **Список интеграций**: Все доступные интеграции
2. **Модальное окно подключения**: Форма авторизации
3. **Модальное окно настройки**: Параметры интеграции
4. **Подключено**: Зеленый индикатор, кнопка "Настроить"
5. **Ошибка подключения**: Красный индикатор, сообщение об ошибке
6. **Синхронизация**: Индикатор процесса синхронизации

## Безопасность

- OAuth токены хранятся в зашифрованном виде
- API ключи не отображаются полностью (маскировка)
- Разрешения можно отозвать в любой момент
- Логирование всех действий через интеграции

## Примечания

- Некоторые интеграции требуют платной подписки на внешний сервис
- Лимиты API внешних сервисов могут ограничивать функционал
- Рекомендуется тестировать интеграции перед активным использованием
