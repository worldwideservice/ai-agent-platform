# Вкладка "Цепочки" (Sequences Tab)

![Скриншот вкладки Цепочки](../screenshots/agent_edit_sequences_tab_1763892055277.png)

## Общее описание
Вкладка "Цепочки" позволяет создавать последовательности автоматических действий агента. Цепочка - это серия шагов, которые выполняются один за другим с определенными задержками или условиями.

## Структура интерфейса

### Заголовок секции
- **Текст**: "Цепочки"
- **Описание**: "Создайте последовательности автоматических действий для агента"

### Кнопка создания цепочки
- **Расположение**: Правая часть заголовка секции
- **Текст**: "+ Создать цепочку"
- **Тип**: Primary button
- **Цвет**: Синий
- **Функционал**: Открывает конструктор цепочки

### Список цепочек

#### Состояние "Пусто"
- **Отображение**: Когда цепочек нет
- **Сообщение**: "У вас пока нет цепочек. Создайте первую цепочку для автоматизации последовательных действий"
- **Иконка**: Иконка цепочки (связанные звенья)
- **Текущее состояние**: Пусто (цепочек не создано)

#### Состояние "Список цепочек" (когда цепочки созданы)
Каждая цепочка отображается как карточка:

##### Структура карточки цепочки:
1. **Название цепочки**
   - Расположение: Верхняя часть карточки
   - Шрифт: Жирный, крупный

2. **Переключатель активности**
   - Тип: Toggle switch
   - Расположение: Правая часть карточки
   - Состояния: ON/OFF

3. **Описание цепочки**
   - Краткое описание назначения цепочки

4. **Количество шагов**
   - Отображение: "X шагов"
   - Иконка: Номер или иконка шагов

5. **Визуализация шагов**
   - Список шагов с иконками
   - Стрелки между шагами
   - Временные задержки между шагами

6. **Статистика**
   - Количество запусков
   - Процент завершения
   - Последний запуск

7. **Кнопки действий**
   - **Редактировать**: Иконка карандаша
   - **Дублировать**: Иконка копирования
   - **Удалить**: Иконка корзины

## Конструктор цепочки (Модальное окно/Страница)

### Основные настройки

#### 1. Название цепочки
- **Тип**: Текстовое поле
- **Обязательность**: Да
- **Placeholder**: "Например: Онбординг нового клиента"

#### 2. Описание
- **Тип**: Текстовое поле (многострочное)
- **Обязательность**: Нет
- **Placeholder**: "Опишите назначение цепочки"

#### 3. Триггер запуска
- **Тип**: Выпадающий список
- **Варианты**:
  - Вручную
  - По триггеру (выбор из списка триггеров)
  - По расписанию
  - При создании сделки
  - При изменении статуса
  - При получении сообщения

### Конструктор шагов

#### Визуальный редактор
- **Тип**: Drag-and-drop конструктор
- **Отображение**: Вертикальный список шагов со стрелками

#### Кнопка добавления шага
- **Текст**: "+ Добавить шаг"
- **Расположение**: Между шагами и в конце списка

#### Типы шагов:

##### 1. Отправить сообщение
- **Канал**: WhatsApp, Email, SMS, Telegram
- **Получатель**: Контакт, Ответственный, Другой
- **Шаблон сообщения**: Текстовое поле с переменными
- **Переменные**: {{имя}}, {{компания}}, {{бюджет}} и т.д.

##### 2. Задержка
- **Время**: Число + единица (минуты, часы, дни)
- **Примеры**: "30 минут", "2 часа", "1 день"

##### 3. Условие
- **Тип**: If-then-else
- **Условие**: Аналогично триггерам
- **Ветвление**: Разные пути выполнения

##### 4. Создать задачу
- **Название**: Текстовое поле
- **Описание**: Текстовое поле
- **Ответственный**: Выбор пользователя
- **Срок**: Дата или относительное время

##### 5. Изменить поле CRM
- **Поле**: Выбор из списка
- **Значение**: Новое значение

##### 6. Добавить тег
- **Тег**: Выбор или создание

##### 7. Назначить ответственного
- **Пользователь**: Выбор из списка

##### 8. Запустить другую цепочку
- **Цепочка**: Выбор из списка

##### 9. Webhook
- **URL**: Текстовое поле
- **Метод**: GET, POST, PUT, DELETE
- **Заголовки**: Ключ-значение
- **Тело запроса**: JSON

#### Настройки шага
Каждый шаг имеет:
- **Название шага**: Для идентификации
- **Описание**: Опциональное
- **Условие выполнения**: Опциональное
- **Действие при ошибке**: Продолжить / Остановить цепочку / Повторить

### Кнопки управления
- **Сохранить**: Сохраняет цепочку
- **Сохранить и запустить**: Сохраняет и сразу запускает
- **Отмена**: Закрывает без сохранения

## Логика работы

### Сценарий создания цепочки:
1. Пользователь нажимает "+ Создать цепочку"
2. Открывается конструктор
3. Пользователь вводит название и описание
4. Пользователь выбирает триггер запуска
5. Пользователь добавляет шаги через "+ Добавить шаг"
6. Для каждого шага настраивает параметры
7. Пользователь может менять порядок шагов (drag-and-drop)
8. Пользователь нажимает "Сохранить"
9. Цепочка добавляется в список

### Сценарий выполнения цепочки:
1. Срабатывает триггер запуска
2. Система начинает выполнение с первого шага
3. Каждый шаг выполняется последовательно
4. При задержке система ждет указанное время
5. При условии выбирается соответствующая ветка
6. При ошибке применяется настроенная стратегия
7. После последнего шага цепочка завершается
8. Логируется результат выполнения

## API взаимодействие

### Получение списка цепочек:
- **Endpoint**: `GET /api/agents/{agentId}/sequences`
- **Response**:
  ```json
  {
    "sequences": [
      {
        "id": "sequence_id",
        "name": "Название цепочки",
        "description": "Описание",
        "active": true,
        "trigger": {
          "type": "manual|trigger|schedule|event",
          "config": {}
        },
        "steps": [
          {
            "id": "step_id",
            "type": "send_message|delay|condition|...",
            "order": 1,
            "config": {
              // Конфигурация шага
            }
          }
        ],
        "stats": {
          "total_runs": 42,
          "completion_rate": 0.95,
          "last_run": "2024-01-15T10:30:00Z"
        }
      }
    ]
  }
  ```

### Создание цепочки:
- **Endpoint**: `POST /api/agents/{agentId}/sequences`

### Обновление цепочки:
- **Endpoint**: `PUT /api/agents/{agentId}/sequences/{sequenceId}`

### Удаление цепочки:
- **Endpoint**: `DELETE /api/agents/{agentId}/sequences/{sequenceId}`

### Запуск цепочки вручную:
- **Endpoint**: `POST /api/agents/{agentId}/sequences/{sequenceId}/run`
- **Payload**:
  ```json
  {
    "context": {
      "lead_id": "123",
      "contact_id": "456"
    }
  }
  ```

## Зависимости

- **Триггеры**: Цепочки могут запускаться триггерами
- **CRM интеграция**: Для работы с данными CRM
- **Интеграции**: Для отправки сообщений через различные каналы
- **Другие цепочки**: Можно запускать цепочки из цепочек

## Валидация

- Название: обязательное, не пустое
- Минимум один шаг
- Все шаги должны быть настроены
- Нет циклических зависимостей при запуске цепочек
- Задержки должны быть положительными числами

## Состояния интерфейса

1. **Пустой список**: Сообщение-заглушка
2. **Список цепочек**: Карточки цепочек
3. **Конструктор (создание)**: Пустая форма
4. **Конструктор (редактирование)**: Форма с данными
5. **Выполнение**: Индикатор прогресса
6. **Завершено**: Статистика выполнения
7. **Ошибка**: Сообщение об ошибке

## Примечания

- Цепочки выполняются асинхронно
- Можно отслеживать прогресс выполнения
- История выполнений сохраняется
- Цепочки можно тестировать перед активацией
- Поддержка ветвления и условной логики
